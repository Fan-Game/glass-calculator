<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –∑–∞—Ä–æ–±—ñ—Ç–∫—É</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
    /* VARIABLES (LIGHT THEME) */
    :root {
        --bg: #f4f4f9;
        --card: #ffffff;
        --txt: #212529;
        --muted: #6c757d;
        --primary: #0056b3;
        --primary-weak: #e7f3ff;
        --ok: #28a745;
        --danger: #dc3545;
        --border: #dee2e6;
        --green-soft: #d4edda;
        --green-soft-hover: #c3e6cb;
        --bg-chart: #ffffff;
        --btn-edit-bg: #e0e7ff;
        --btn-edit-txt: #3f51b5;
        --btn-del-bg: #ffebee;
        --btn-del-txt: #c62828;
        --btn-primary-bg: #007bff;
        --btn-primary-hover: #0069d9;
    }

    /* DARK THEME */
    .dark-mode {
        --bg: #121212;
        --card: #1e1e1e;
        --txt: #e0e0e0;
        --muted: #b0b0b0;
        --primary: #4a90e2;
        --primary-weak: #283e58;
        --ok: #4caf50;
        --danger: #f44336;
        --border: #333;
        --green-soft: #2f4f4f;
        --green-soft-hover: #3a5f5f;
        --bg-chart: #1e1e1e;
        --btn-edit-bg: #2a3a59;
        --btn-edit-txt: #9ab4f0;
        --btn-del-bg: #4d2e2e;
        --btn-del-txt: #f77f7f;
        --btn-primary-bg: #0056b3;
        --btn-primary-hover: #004494;
    }

    body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
        background: var(--bg);
        color: var(--txt);
        padding: 10px;
        transition: background-color 0.3s, color 0.3s;
    }

    .container {
        max-width: 900px;
        margin: auto;
        background: var(--card);
        padding: 16px 16px 24px;
        border-radius: 12px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, .08);
        transition: background-color 0.3s;
    }
    .main-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin: 0 8px 8px 8px;
    }
    .theme-toggle-btn {
        background: none;
        border: none;
        font-size: 1.5em;
        cursor: pointer;
        color: var(--txt);
        padding: 0;
    }

    h2 { margin: 0; text-align: left; }

    /* Tabs */
    .tabs {
        display: flex; gap: 6px; flex-wrap: nowrap; overflow-x: auto;
        border-bottom: 1px solid var(--border); margin-bottom: 12px;
    }
    .tabs::-webkit-scrollbar { display: none; }
    .tabs { -ms-overflow-style: none; scrollbar-width: none; }
    
    .tab-btn {
        padding: 10px 14px; border: none; background: #f6f7fb; border-radius: 10px 10px 0 0;
        cursor: pointer; font-weight: 600; color: #222; flex-shrink: 0;
        transition: background-color 0.2s, color 0.2s;
    }
    .dark-mode .tab-btn { background: #252525; color: #ccc; }
    .tab-btn[aria-selected="true"] { background: var(--primary); color: #fff; }

    .tab-panel { display: none; animation: fade .15s ease; }
    .tab-panel.active { display: block; }
    @keyframes fade { from { opacity: .5; transform: translateY(4px); } to { opacity: 1; transform: none; } }

    .item { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    .item label { flex-basis: 60%; }
    .item input, .item textarea, .item select, #workerFilter {
        width: 110px; padding: 8px; font-size: 1em; text-align: right;
        border: 1px solid var(--border); border-radius: 6px;
        background: var(--bg); color: var(--txt);
        transition: background-color 0.3s, color 0.3s, border-color 0.3s;
    }
    .item textarea { width: 100%; height: 60px; box-sizing: border-box; }
    #workerFilter, .inline-form input, .new-category-form input { width: 100%; box-sizing: border-box; text-align: left; }
    .inline-form, .new-category-form { display: flex; gap: 8px; margin-top: 12px; flex-wrap: wrap; }
    .inline-form input { flex: 1; min-width: 120px; }
    .inline-form button { flex-basis: content; white-space: nowrap; }


    .date-selector { text-align: center; margin-bottom: 16px; }
    .date-selector input {
        padding: 8px; font-size: 1.05em; border: 1px solid var(--border); border-radius: 6px;
        background: var(--bg); color: var(--txt);
    }

    /* Primary buttons styles */
    .actions { display: flex; flex-direction: column; gap: 10px; margin-top: 10px; }
    .primary-btn {
        width: 100%; padding: 14px; font-size: 1.05em; border: none; border-radius: 10px;
        cursor: pointer; font-weight: 700; color: #fff;
        transition: background-color 0.2s;
        background: var(--btn-primary-bg);
        box-sizing: border-box;
    }
    .primary-btn:hover { background: var(--btn-primary-hover); }
    .primary-btn.ok { background: var(--ok); }
    .primary-btn.danger { background: var(--danger); }
    
    #result {
        font-size: 1.2em; text-align: center; margin: 14px 0;
        color: var(--primary); background: var(--primary-weak); padding: 10px; border-radius: 10px;
    }
    #result .result-line { display: flex; justify-content: space-between; padding: 2px 0; }
    #result .result-line .label { font-weight: 500; }
    #result .result-line .value { font-weight: 700; }
    #result .tax-amount { color: var(--danger); }
    #result .final-total { color: var(--ok); font-size: 1.3em; }

    .section-card { border: 1px solid var(--border); border-radius: 10px; padding: 12px; background: var(--bg); transition: background-color 0.3s, border-color 0.3s; }

    /* Workers */
    .workers-grid-item { display: flex; justify-content: space-between; align-items: center; padding: 6px 0; border-bottom: 1px solid var(--border); }
    .workers-grid-item:last-child { border-bottom: none; }
    .workers-grid-item .name { font-weight: 600; flex-grow: 1; }
    .workers-grid-item .coef { color: var(--muted); flex-shrink: 0; }
    .workers-grid-item .actions { display: flex; gap: 6px; justify-content: flex-end; flex-shrink: 0; }
    .workers-grid-item button { padding: 6px 10px; border: none; border-radius: 8px; cursor: pointer; transition: background-color 0.2s, color 0.2s; }
    .edit-btn { background: var(--btn-edit-bg); color: var(--btn-edit-txt); }
    .del-btn { background: var(--btn-del-bg); color: var(--btn-del-txt); }

    /* Checkboxes & Shift breakdown */
    .checkbox-list label { display: block; margin: 5px 0; }
    .salary-table { margin-top: 10px; border-top: 1px solid var(--border); padding-top: 6px; }
    .salary-table .row { display: flex; justify-content: space-between; margin: 4px 0; }
    .salary-table .row strong { font-weight: 700; }
    .shift-summary { border: 1px solid var(--border); border-radius: 8px; padding: 10px; margin-bottom: 10px; background: var(--bg); }
    .shift-summary-header { display: flex; justify-content: space-between; align-items: center; font-weight: bold; cursor: pointer; }
    .shift-details { margin-top: 10px; display: none; }
    .shift-details.active { display: block; }

    /* History */
    #historyContainer { margin-top: 20px; padding-top: 10px; }
    #historyContainer h3 { text-align: center; margin: 10px 0; }
    .month-group .month-header {
        display: flex; justify-content: space-between; align-items: center; padding: 12px;
        background: var(--green-soft); font-weight: 700; border-radius: 10px;
        cursor: pointer; margin-top: 10px; transition: background-color 0.2s;
    }
    .month-group .month-header:hover { background: var(--green-soft-hover); }
    .month-group .days-list { list-style: none; padding: 0 0 0 14px; margin: 0; border-left: 2px solid var(--green-soft); max-height: 900px; overflow: hidden; transition: max-height .25s ease; }
    .month-group.collapsed .days-list { max-height: 0; }
    .month-group .days-list li {
        background: #f9f9f9; padding: 8px; margin: 6px 0; border-radius: 8px; cursor: pointer;
        display: grid; grid-template-columns: 1fr auto; align-items: center;
        transition: background-color 0.2s;
    }
    .dark-mode .month-group .days-list li { background: #252525; }
    .month-group .days-list li:hover { background: #efefef; }
    .dark-mode .month-group .days-list li:hover { background: #303030; }
    .history-entry-compact { display: flex; justify-content: space-between; align-items: center; width: 100%; gap: 8px; }
    .history-date { font-weight: bold; color: var(--primary); flex-shrink: 0; min-width: 80px; }
    .history-total { font-weight: bold; color: var(--txt); }
    .history-notes { font-style: italic; color: var(--muted); font-size: 0.9em; margin-top: 4px; width: 100%; white-space: pre-wrap; grid-column: 1 / -1; }
    .history-delete-btn, .history-edit-btn { background: var(--btn-del-bg); color: var(--btn-del-txt); border: none; border-radius: 6px; padding: 4px 8px; font-weight: bold; cursor: pointer; font-size: 1.1em; line-height: 1; transition: background-color 0.2s ease; }
    .history-edit-btn { background: var(--btn-edit-bg); color: var(--btn-edit-txt); }
    .arrow { transition: transform .2s; display: inline-block; }
    .collapsed .arrow { transform: rotate(-90deg); }

    /* Toast Notification Styles */
    #toast-notification {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        background-color: var(--ok);
        color: #fff;
        padding: 12px 20px;
        border-radius: 10px;
        font-size: 1em;
        font-weight: 600;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        opacity: 0;
        visibility: hidden;
        transition: all 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55);
        z-index: 1000;
        min-width: 250px;
        text-align: center;
    }
    #toast-notification.show {
        visibility: visible;
        opacity: 1;
        bottom: 30px;
    }
    .dark-mode #toast-notification {
        background-color: var(--ok);
    }
</style>
</head>
<body>
<div class="container">
    <div class="main-header">
        <h2>–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –∑–∞—Ä–æ–±—ñ—Ç–∫—É</h2>
        <button id="theme-toggle-btn" class="theme-toggle-btn">‚òÄÔ∏è</button>
    </div>

    <div class="tabs" role="tablist" aria-label="–ù–∞–≤—ñ–≥–∞—Ü—ñ—è">
        <button class="tab-btn" role="tab" aria-selected="true" data-tab="calc">–†–æ–∑—Ä–∞—Ö—É–Ω–æ–∫</button>
        <button class="tab-btn" role="tab" aria-selected="false" data-tab="workers">–ü—Ä–∞—Ü—ñ–≤–Ω–∏–∫–∏</button>
        <button class="tab-btn" role="tab" aria-selected="false" data-tab="history">–Ü—Å—Ç–æ—Ä—ñ—è</button>
        <button class="tab-btn" role="tab" aria-selected="false" data-tab="prices">–¶—ñ–Ω–∏</button>
    </div>

    <section id="tab-calc" class="tab-panel active" role="tabpanel">
        <div class="date-selector">
            <label for="currentDate"><b>–î–∞—Ç–∞:</b> </label>
            <input type="date" id="currentDate">
        </div>
        <div id="shiftsContainer"></div>
        <div id="inputs"></div>
        <div id="result">–í—Å—å–æ–≥–æ: 0.00</div>
        <div class="section-card" style="margin-top:16px;">
            <h3 style="margin:6px 0 8px;">–•—Ç–æ –ø—Ä–∞—Ü—é–≤–∞–≤ —É –∑–º—ñ–Ω—É?</h3>
            <div class="checkbox-list" id="workerCheckboxes"></div>
            <div id="shiftBreakdown" class="salary-table"></div>
        </div>
        <div class="section-card" style="margin-top:16px;">
            <h3 style="margin:6px 0 8px;">–ù–æ—Ç–∞—Ç–∫–∏</h3>
            <textarea id="notes" placeholder="–î–æ–¥–∞—Ç–∏ –∫–æ–º–µ–Ω—Ç–∞—Ä –¥–æ –∑–º—ñ–Ω–∏"></textarea>
        </div>
        <div class="actions">
            <button id="saveBtn" class="primary-btn ok">–ó–ë–ï–†–ï–ì–¢–ò –ó–ú–Ü–ù–£</button>
            <button id="addShiftBtn" class="primary-btn">–î–û–î–ê–¢–ò –ù–û–í–£ –ó–ú–Ü–ù–£</button>
            <button id="clearCurrentBtn" class="primary-btn danger">–û–ß–ò–°–¢–ò–¢–ò –§–û–†–ú–£</button>
        </div>
    </section>

    <section id="tab-workers" class="tab-panel" role="tabpanel">
        <div class="section-card">
            <h3 style="margin:0 0 8px;text-align:center;">–°–ø–∏—Å–æ–∫ –ø—Ä–∞—Ü—ñ–≤–Ω–∏–∫—ñ–≤</h3>
            <div id="workerList" class="workers-grid"></div>
            <div class="inline-form">
                <input type="text" id="workerName" placeholder="–Ü–º'—è" />
                <input type="number" id="workerCoef" step="0.01" placeholder="–ö–æ–µ—Ñ." />
                <button class="primary-btn" id="addOrUpdateBtn">–î–æ–¥–∞—Ç–∏</button>
                <button class="primary-btn danger" id="resetWorkerBtn">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
            </div>
        </div>
        <div class="section-card" style="margin-top:16px;">
            <h3 style="margin:0 0 8px;text-align:center;">–ü—ñ–¥—Å—É–º–æ–∫ –∑–∞ –ø–æ—Ç–æ—á–Ω–∏–π –º—ñ—Å—è—Ü—å</h3>
            <div id="workerTotals"></div>
        </div>
    </section>

    <section id="tab-history" class="tab-panel" role="tabpanel">
        <div class="section-card">
            <h3 style="margin:0 0 8px;text-align:center;">–ì—Ä–∞—Ñ—ñ–∫ –∑–∞—Ä–æ–±—ñ—Ç–∫—É</h3>
            <div style="padding: 10px; border-radius: 10px; background: var(--bg-chart); border: 1px solid var(--border);">
                <canvas id="earningsChart"></canvas>
            </div>
        </div>
        <div class="section-card" style="margin-top:16px;">
            <h3 style="margin:0 0 8px;text-align:center;">–§—ñ–ª—å—Ç—Ä –ø–æ –ø—Ä–∞—Ü—ñ–≤–Ω–∏–∫—É</h3>
            <select id="workerFilter">
                <option value="all">–í—Å—ñ –ø—Ä–∞—Ü—ñ–≤–Ω–∏–∫–∏</option>
            </select>
        </div>
        <div id="historyContainer">
            <h3 style="margin-top: 16px;">–Ü—Å—Ç–æ—Ä—ñ—è –∑–∞–ø–∏—Å—ñ–≤</h3>
            <div id="history"></div>
            <div class="actions">
                <button id="restoreBtn" class="primary-btn">–í–Ü–î–ù–û–í–ò–¢–ò –ó –§–ê–ô–õ–ê</button>
                <input type="file" id="loadFile" accept=".json" style="display: none;">
                <button id="saveFileBtn" class="primary-btn">–ó–ë–ï–†–ï–ì–¢–ò –í –§–ê–ô–õ</button>
                <button id="clearBtn" class="primary-btn danger">–û—á–∏—Å—Ç–∏—Ç–∏ –≤—Å—é —ñ—Å—Ç–æ—Ä—ñ—é</button>
            </div>
        </div>
    </section>

    <section id="tab-prices" class="tab-panel" role="tabpanel">
        <div class="section-card">
            <h3 style="margin:0 0 8px;text-align:center;">–†–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è —Ü—ñ–Ω</h3>
            <div id="priceInputs"></div>
            <div class="actions">
                <button id="savePricesBtn" class="primary-btn">–ó–ë–ï–†–ï–ì–¢–ò –¶–Ü–ù–ò</button>
            </div>
        </div>
        <div class="section-card" style="margin-top:16px;">
            <h3 style="margin:0 0 8px;text-align:center;">–ö–µ—Ä—É–≤–∞–Ω–Ω—è –≤–ª–∞—Å–Ω–∏–º–∏ –∫–∞—Ç–µ–≥–æ—Ä—ñ—è–º–∏</h3>
            <div id="customCategoriesList" class="workers-grid"></div>
            <div class="inline-form">
                <input type="text" id="newCategoryName" placeholder="–ù–∞–∑–≤–∞ –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó" />
                <input type="number" id="newCategoryPrice" step="0.01" placeholder="–¶—ñ–Ω–∞" />
                <button class="primary-btn ok" id="addOrUpdateCategoryBtn">–î–æ–¥–∞—Ç–∏</button>
                <button class="primary-btn danger" id="resetCategoryBtn">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
            </div>
        </div>
    </section>
</div>
<div id="toast-notification"></div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    /* ======= –î–∞–Ω—ñ —Ç–∞ –¥–æ–≤—ñ–¥–Ω–∏–∫–∏ ======= */
    const GOOGLE_SHEETS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbywAlba1OGfCnchOwWWm-BXqMla9Nl4GQGQ2wPw4EvsHZO0PWcY2eyy4y4uWJ1Xu9rHBQ/exec'; // üö® –í—Å—Ç–∞–≤—Ç–µ –≤–∞—à—É URL-–∞–¥—Ä–µ—Å—É —Ç—É—Ç!

    const defaultGlassTypes = {
        hst: { name: 'HST', price: 11 }, s4: { name: '–°–∫–ª–æ 4', price: 11.64 }, s5: { name: '–°–∫–ª–æ 5', price: 9.6 },
        s6f: { name: '–°–∫–ª–æ 6F', price: 12.18 }, s6: { name: '–°–∫–ª–æ 6', price: 10.8 }, s8f: { name: '–°–∫–ª–æ 8F', price: 13.44 },
        s8: { name: '–°–∫–ª–æ 8', price: 16.88 }, s10f: { name: '–°–∫–ª–æ 10F', price: 22.40 }, s10: { name: '–°–∫–ª–æ 10', price: 24.40 },
        linMeters: { name: '–ú–µ—Ç—Ä—ñ–≤ –ø–æ–≥.', price: 1.15 }
    };
    let allCategories = new Map();
    let taxRate = 0;
    let chartInstance = null;
    const monthNames = ["—Å—ñ—á–Ω—è", "–ª—é—Ç–æ–≥–æ", "–±–µ—Ä–µ–∑–Ω—è", "–∫–≤—ñ—Ç–Ω—è", "—Ç—Ä–∞–≤–Ω—è", "—á–µ—Ä–≤–Ω—è", "–ª–∏–ø–Ω—è", "—Å–µ—Ä–ø–Ω—è", "–≤–µ—Ä–µ—Å–Ω—è", "–∂–æ–≤—Ç–Ω—è", "–ª–∏—Å—Ç–æ–ø–∞–¥–∞", "–≥—Ä—É–¥–Ω—è"];
    const monthNamesFull = ["–°—ñ—á–µ–Ω—å", "–õ—é—Ç–∏–π", "–ë–µ—Ä–µ–∑–µ–Ω—å", "–ö–≤—ñ—Ç–µ–Ω—å", "–¢—Ä–∞–≤–µ–Ω—å", "–ß–µ—Ä–≤–µ–Ω—å", "–õ–∏–ø–µ–Ω—å", "–°–µ—Ä–ø–µ–Ω—å", "–í–µ—Ä–µ—Å–µ–Ω—å", "–ñ–æ–≤—Ç–µ–Ω—å", "–õ–∏—Å—Ç–æ–ø–∞–¥", "–ì—Ä—É–¥–µ–Ω—å"];

    /* ======= DOM –µ–ª–µ–º–µ–Ω—Ç–∏ ======= */
    const dateInput = document.getElementById('currentDate'), inputsContainer = document.getElementById('inputs'),
        resultEl = document.getElementById('result'), historyEl = document.getElementById('history'),
        workerListEl = document.getElementById('workerList'), workerCheckboxes = document.getElementById('workerCheckboxes'),
        shiftBreakdown = document.getElementById('shiftBreakdown'), addOrUpdateWorkerBtn = document.getElementById('addOrUpdateBtn'),
        resetWorkerBtn = document.getElementById('resetWorkerBtn'), priceInputsContainer = document.getElementById('priceInputs'),
        workerTotalsEl = document.getElementById('workerTotals'), notesInput = document.getElementById('notes'),
        workerFilterSelect = document.getElementById('workerFilter'), loadFileInput = document.getElementById('loadFile'),
        themeToggleBtn = document.getElementById('theme-toggle-btn'), earningsChartCanvas = document.getElementById('earningsChart'),
        saveBtn = document.getElementById('saveBtn'), saveFileBtn = document.getElementById('saveFileBtn'),
        clearBtn = document.getElementById('clearBtn'), savePricesBtn = document.getElementById('savePricesBtn'),
        restoreBtn = document.getElementById('restoreBtn'), tabButtons = document.querySelectorAll('.tab-btn'),
        panels = { calc: document.getElementById('tab-calc'), workers: document.getElementById('tab-workers'), history: document.getElementById('tab-history'), prices: document.getElementById('tab-prices') },
        addShiftBtn = document.getElementById('addShiftBtn'), clearCurrentBtn = document.getElementById('clearCurrentBtn'),
        shiftsContainer = document.getElementById('shiftsContainer');
    const addOrUpdateCategoryBtn = document.getElementById('addOrUpdateCategoryBtn');
    const resetCategoryBtn = document.getElementById('resetCategoryBtn');
    const newCategoryNameInput = document.getElementById('newCategoryName');
    const newCategoryPriceInput = document.getElementById('newCategoryPrice');
    const customCategoriesListEl = document.getElementById('customCategoriesList');
    const toastNotification = document.getElementById('toast-notification');

    let currentShiftId = null;

    /* ======= Toast Notification Function ======= */
    const showToast = (message, isError = false) => {
        toastNotification.textContent = message;
        toastNotification.style.backgroundColor = isError ? 'var(--danger)' : 'var(--ok)';
        toastNotification.classList.add('show');
        setTimeout(() => {
            toastNotification.classList.remove('show');
        }, 3000);
    };

    /* ======= Tabs ======= */
    tabButtons.forEach(btn => btn.addEventListener('click', () => {
        const key = btn.dataset.tab;
        Object.values(panels).forEach(p => p.classList.remove('active'));
        panels[key].classList.add('active');
        tabButtons.forEach(b => b.setAttribute('aria-selected', b === btn ? 'true' : 'false'));
        localStorage.setItem('activeTab', key);
        if (key === 'history') { displayHistory(); renderEarningsChart(); }
        if (key === 'prices') { createPriceInputs(); renderCustomCategories(); } 
        if (key === 'calc') createInputs();
        if (key === 'workers') renderWorkerTotals();
    }));
    const restoreTab = () => { const key = localStorage.getItem('activeTab'); if (key && panels[key]) document.querySelector(`.tab-btn[data-tab="${key}"]`).click(); };

    /* ======= Light/Dark Theme ======= */
    const toggleTheme = () => {
        const isDarkMode = document.body.classList.toggle('dark-mode');
        localStorage.setItem('theme', isDarkMode ? 'dark' : 'light');
        themeToggleBtn.textContent = isDarkMode ? 'üåô' : '‚òÄÔ∏è';
        if (chartInstance) { chartInstance.destroy(); renderEarningsChart(); }
    };
    const loadTheme = () => {
        if (localStorage.getItem('theme') === 'dark') { document.body.classList.add('dark-mode'); themeToggleBtn.textContent = 'üåô'; } 
        else { document.body.classList.remove('dark-mode'); themeToggleBtn.textContent = '‚òÄÔ∏è'; }
    };

    /* ======= Data Persistence (–ø–µ—Ä–µ–Ω–µ—Å–µ–Ω–æ –¥–æ Google Sheets) ======= */
    const getWorkers = () => JSON.parse(localStorage.getItem('workers')) || [];
    const saveWorkers = (workers) => localStorage.setItem('workers', JSON.stringify(workers));
    
    const loadPrices = () => { 
        allCategories = new Map(Object.entries(defaultGlassTypes));
        const customCategories = JSON.parse(localStorage.getItem('customCategories')) || {};
        for (const [id, value] of Object.entries(customCategories)) {
            allCategories.set(id, value);
        }
        taxRate = parseFloat(localStorage.getItem('glassTaxRate')) || 0; 
    };

    const savePrices = () => {
        const tempCategories = new Map();
        let allValid = true;

        for (const [id, value] of allCategories.entries()) {
            const input = document.getElementById(`price-${id}`);
            if (input) {
                const price = parseFloat(input.value);
                if (isNaN(price) || price < 0) {
                    showToast(`–ù–µ–∫–æ—Ä–µ–∫—Ç–Ω–∞ —Ü—ñ–Ω–∞ –¥–ª—è ${value.name}!`, true);
                    allValid = false;
                    break;
                }
                tempCategories.set(id, { name: value.name, price: price });
            }
        }
        
        const newTaxRate = parseFloat(document.getElementById('taxRate').value);
        if (isNaN(newTaxRate) || newTaxRate < 0) {
            showToast('–ù–µ–∫–æ—Ä–µ–∫—Ç–Ω–∏–π –≤—ñ–¥—Å–æ—Ç–æ–∫ –ø–æ–¥–∞—Ç–∫—É!', true);
            allValid = false;
        }
        
        if (allValid) {
            const pricesToSave = {};
            const customPricesToSave = {};
            for (const [id, value] of tempCategories.entries()) {
                if (defaultGlassTypes[id]) {
                    pricesToSave[id] = value;
                } else {
                    customPricesToSave[id] = value;
                }
            }
            localStorage.setItem('glassPrices', JSON.stringify(pricesToSave));
            localStorage.setItem('customCategories', JSON.stringify(customPricesToSave));
            localStorage.setItem('glassTaxRate', newTaxRate);
            
            loadPrices();
            createInputs();
            renderWorkerTotals();
            displayHistory();
            showToast('–¶—ñ–Ω–∏ —Ç–∞ –ø–æ–¥–∞—Ç–æ–∫ –∑–±–µ—Ä–µ–∂–µ–Ω–æ!');
        }
    };
    
    /* ======= –£–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è –∫–∞—Ç–µ–≥–æ—Ä—ñ—è–º–∏ ======= */
    let editCategoryId = null;

    const renderCustomCategories = () => {
        const customCategories = JSON.parse(localStorage.getItem('customCategories')) || {};
        customCategoriesListEl.innerHTML = '';
        if (Object.keys(customCategories).length === 0) {
            customCategoriesListEl.innerHTML = `<div style="color:var(--muted);padding:6px 0;">–ü–æ–∫–∏ –Ω–µ–º–∞—î –≤–ª–∞—Å–Ω–∏—Ö –∫–∞—Ç–µ–≥–æ—Ä—ñ–π.</div>`;
            return;
        }
        for (const id in customCategories) {
            const cat = customCategories[id];
            const row = document.createElement('div');
            row.className = 'workers-grid-item';
            row.dataset.id = id;
            row.innerHTML = `
                <div class="name">${cat.name}</div>
                <div class="coef">—Ü—ñ–Ω–∞: ${cat.price.toFixed(2)}</div>
                <div class="actions">
                    <button class="edit-btn">‚úé</button>
                    <button class="del-btn">‚úñ</button>
                </div>
            `;
            customCategoriesListEl.appendChild(row);
        }
    };

    const startEditCategory = (id) => {
        const customCategories = JSON.parse(localStorage.getItem('customCategories')) || {};
        const cat = customCategories[id];
        if (cat) {
            newCategoryNameInput.value = cat.name;
            newCategoryPriceInput.value = cat.price;
            editCategoryId = id;
            addOrUpdateCategoryBtn.textContent = '–û–Ω–æ–≤–∏—Ç–∏';
        }
    };

    const resetCategoryForm = () => {
        newCategoryNameInput.value = '';
        newCategoryPriceInput.value = '';
        editCategoryId = null;
        addOrUpdateCategoryBtn.textContent = '–î–æ–¥–∞—Ç–∏';
    };
    
    const handleAddOrUpdateCategory = () => {
        const name = newCategoryNameInput.value.trim();
        const price = parseFloat(newCategoryPriceInput.value);
        
        if (!name || isNaN(price) || price < 0) {
            showToast('–ë—É–¥—å –ª–∞—Å–∫–∞, –≤–≤–µ–¥—ñ—Ç—å –∫–æ—Ä–µ–∫—Ç–Ω—ñ –Ω–∞–∑–≤—É —Ç–∞ —Ü—ñ–Ω—É!', true);
            return;
        }

        let customCategories = JSON.parse(localStorage.getItem('customCategories')) || {};
        const newId = name.toLowerCase().replace(/\s/g, '');

        if (editCategoryId) {
            if (editCategoryId !== newId && (customCategories[newId] || defaultGlassTypes[newId])) {
                showToast('–ö–∞—Ç–µ–≥–æ—Ä—ñ—è –∑ —Ç–∞–∫–æ—é –Ω–∞–∑–≤–æ—é –≤–∂–µ —ñ—Å–Ω—É—î. –ë—É–¥—å –ª–∞—Å–∫–∞, –æ–±–µ—Ä—ñ—Ç—å —ñ–Ω—à—É –Ω–∞–∑–≤—É.', true);
                return;
            }
            delete customCategories[editCategoryId];
            customCategories[newId] = { name, price };
            editCategoryId = null;
        } else {
            if (customCategories[newId] || defaultGlassTypes[newId]) {
                showToast('–ö–∞—Ç–µ–≥–æ—Ä—ñ—è –∑ —Ç–∞–∫–æ—é –Ω–∞–∑–≤–æ—é –≤–∂–µ —ñ—Å–Ω—É—î. –ë—É–¥—å –ª–∞—Å–∫–∞, –æ–±–µ—Ä—ñ—Ç—å —ñ–Ω—à—É –Ω–∞–∑–≤—É.', true);
                return;
            }
            customCategories[newId] = { name, price };
        }
        
        localStorage.setItem('customCategories', JSON.stringify(customCategories));
        
        loadPrices();
        renderCustomCategories();
        createPriceInputs();
        
        resetCategoryForm();
        showToast('–ö–∞—Ç–µ–≥–æ—Ä—ñ—é –∑–±–µ—Ä–µ–∂–µ–Ω–æ!');
    };

    const removeCustomCategory = (id) => {
        if (confirm('–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ –≤–∏–¥–∞–ª–∏—Ç–∏ —Ü—é –∫–∞—Ç–µ–≥–æ—Ä—ñ—é?')) {
            const customCategories = JSON.parse(localStorage.getItem('customCategories')) || {};
            delete customCategories[id];
            localStorage.setItem('customCategories', JSON.stringify(customCategories));
            loadPrices();
            renderCustomCategories();
            createPriceInputs();
            createInputs();
            showToast('–ö–∞—Ç–µ–≥–æ—Ä—ñ—é –≤–∏–¥–∞–ª–µ–Ω–æ!');
        }
    };

    /* ======= UI Creation ======= */
    const createInputs = () => {
        inputsContainer.innerHTML = '';
        allCategories.forEach((item, id) => {
            const isGlass = defaultGlassTypes[id] && id !== 'linMeters';
            const placeholderText = isGlass ? '–º¬≤' : (id === 'linMeters' ? '–º. –ø–æ–≥.' : '–∫—ñ–ª—å–∫—ñ—Å—Ç—å');
            inputsContainer.innerHTML += `<div class="item"><label for="${id}">${item.name} (${item.price.toFixed(2)}):</label><input type="number" id="${id}" min="0" step="0.01" placeholder="${placeholderText}"></div>`;
        });
        inputsContainer.querySelectorAll('input').forEach(input => input.addEventListener('input', onInputsChange));
    };

    const createPriceInputs = () => {
        priceInputsContainer.innerHTML = '';
        allCategories.forEach((item, id) => {
            priceInputsContainer.innerHTML += `<div class="item"><label for="price-${id}">${item.name}:</label><input type="number" id="price-${id}" min="0" step="0.01" value="${item.price.toFixed(2)}"></div>`;
        });
        priceInputsContainer.innerHTML += `<div class="item"><label for="taxRate">–ü–æ–¥–∞—Ç–æ–∫ (%):</label><input type="number" id="taxRate" min="0" step="0.1" value="${taxRate.toFixed(2)}"></div>`;
    };

    /* ======= Calculation Logic ======= */
    const calculate = () => {
        let total = 0, totalM2 = 0;
        const glassDetails = {};
        allCategories.forEach((item, id) => {
            const val = parseFloat(document.getElementById(id)?.value) || 0;
            if (val > 0) {
                total += val * item.price;
                if (defaultGlassTypes[id] && id !== 'linMeters') totalM2 += val;
                glassDetails[item.name] = val;
            }
        });
        const taxAmount = taxRate > 0 ? total * (taxRate / 100) : 0;
        const totalAfterTax = total - taxAmount;
        return { total: total.toFixed(2), totalM2: totalM2.toFixed(2), taxAmount: taxAmount.toFixed(2), totalAfterTax: totalAfterTax.toFixed(2), glassDetails };
    };
    const onInputsChange = () => {
        const { total, totalM2, taxAmount, totalAfterTax } = calculate();
        resultEl.innerHTML = `
            <div class="result-line">
                <span class="label">–ó–∞–≥–∞–ª—å–Ω–∞ —Å—É–º–∞:</span>
                <span class="value">${total}</span>
            </div>
            <div class="result-line">
                <span class="label">–ü–æ–¥–∞—Ç–æ–∫ (${taxRate}%):</span>
                <span class="value tax-amount">- ${taxAmount}</span>
            </div>
            <div class="result-line total-line">
                <span class="label">–î–æ –≤–∏–ø–ª–∞—Ç–∏:</span>
                <span class="value final-total">${totalAfterTax}</span>
            </div>
            <div class="result-line" style="font-weight: normal; font-size: 0.8em; color: var(--muted); margin-top: 5px;">
                ${totalM2} –º¬≤, ${parseFloat(document.getElementById('linMeters')?.value || 0).toFixed(2)} –º. –ø–æ–≥.
            </div>
        `;
        renderShiftBreakdown(parseFloat(totalAfterTax));
    };

    /* ======= –ß–µ–∫–±–æ–∫—Å–∏ –ø—Ä–∞—Ü—ñ–≤–Ω–∏–∫—ñ–≤ —É –∑–º—ñ–Ω—ñ ======= */
    const renderWorkerCheckboxes = (selected = []) => {
        const workers = getWorkers();
        workerCheckboxes.innerHTML = '';
        workers.forEach(w => {
            const lbl = document.createElement('label');
            const checked = selected.some(sel => sel.name === w.name);
            lbl.innerHTML = `<input type="checkbox" value="${w.name}" ${checked ? 'checked' : ''}> ${w.name}`;
            workerCheckboxes.appendChild(lbl);
        });
        workerCheckboxes.querySelectorAll('input[type="checkbox"]').forEach(ch => {
            ch.addEventListener('change', onInputsChange);
        });
    };

    /* ======= –†–æ–∑–ø–æ–¥—ñ–ª –ø–æ –∑–º—ñ–Ω—ñ (–æ–Ω–ª–∞–π–Ω) ======= */
    const renderShiftBreakdown = (dayTotal) => {
        const selectedWorkers = getSelectedWorkers();
        shiftBreakdown.innerHTML = '';
        if (selectedWorkers.length === 0) {
            shiftBreakdown.innerHTML = `<div class="row" style="color:var(--muted)">–ù—ñ–∫–æ–≥–æ –Ω–µ –æ–±—Ä–∞–Ω–æ —É –∑–º—ñ–Ω—É</div>`;
            return;
        }
        const sumCoef = selectedWorkers.reduce((s, w) => s + Number(w.coef || 0), 0) || 1;
        selectedWorkers.forEach(w => {
            const salary = dayTotal * w.coef / sumCoef;
            const row = document.createElement('div');
            row.className = 'row';
            row.innerHTML = `<span>${w.name}</span><strong>${salary.toFixed(2)}</strong>`;
            shiftBreakdown.appendChild(row);
        });
    };

    /* ======= –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è –¥–Ω—è (–≤ Google Sheets) ======= */
    const saveData = async () => {
        const date = dateInput.value;
        if (!date) {
            showToast('–ë—É–¥—å –ª–∞—Å–∫–∞, –≤–∏–±–µ—Ä—ñ—Ç—å –¥–∞—Ç—É!', true);
            return;
        }
    
        const { total, taxAmount, totalAfterTax, glassDetails } = calculate();
        if (parseFloat(total) <= 0) {
            showToast('–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö –¥–ª—è –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è!', true);
            return;
        }
    
        const selectedWorkers = getSelectedWorkers();
        const notes = notesInput.value.trim();
        
        const dataToSend = {
            date: date,
            notes: notes,
            workers: selectedWorkers,
            total,
            taxAmount,
            totalAfterTax,
            glass: glassDetails
        };
    
        try {
            const response = await fetch(GOOGLE_SHEETS_SCRIPT_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(dataToSend)
            });
            const result = await response.json();
            
            if (result.result === "success") {
                showToast("–î–∞–Ω—ñ —É—Å–ø—ñ—à–Ω–æ –∑–±–µ—Ä–µ–∂–µ–Ω–æ –≤ Google –¢–∞–±–ª–∏—Ü—é!");
                clearCurrentForm();
            } else {
                showToast("–ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ Apps Script.", true);
            }
        } catch (error) {
            console.error('Error:', error);
            showToast("–ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥–ø—Ä–∞–≤–∫–∏ –¥–∞–Ω–∏—Ö. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ URL.", true);
        }
    };
    

    const clearCurrentForm = () => {
        document.querySelectorAll('#inputs input').forEach(input => input.value = '');
        notesInput.value = '';
        renderWorkerCheckboxes();
        onInputsChange();
        currentShiftId = null;
        saveBtn.textContent = '–ó–ë–ï–†–ï–ì–¢–ò –ó–ú–Ü–ù–£';
    };

    const loadShiftForEdit = (date, shiftId) => {
        showToast('–§—É–Ω–∫—Ü—ñ—è —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è —ñ—Å—Ç–æ—Ä—ñ—ó –Ω–∞—Ä–∞–∑—ñ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ –ø—Ä–∏ —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—ó –∑ Google –¢–∞–±–ª–∏—Ü—è–º–∏.', true);
        // –ó–∞–ª–∏—à–∏–º–æ —Ü—é —Ñ—É–Ω–∫—Ü—ñ—é –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è, –∞–ª–µ –¥–µ–∞–∫—Ç–∏–≤—É—î–º–æ –¥–ª—è —Ö–º–∞—Ä–∏
    };

    /* ======= –§–æ—Ä–º–∞—Ç –¥–∞—Ç–∏ ======= */
    const formatDate = (dateStr) => {
        const [y, m, d] = dateStr.split('-');
        return `${parseInt(d)} ${monthNames[parseInt(m)-1]}`;
    };

    /* ======= –Ü—Å—Ç–æ—Ä—ñ—è (–±—ñ–ª—å—à–µ –Ω–µ –∑–±–µ—Ä—ñ–≥–∞—î—Ç—å—Å—è –ª–æ–∫–∞–ª—å–Ω–æ) ======= */
    const displayHistory = () => {
        historyEl.innerHTML = `<div style="color:var(--muted);text-align:center;">
            –Ü—Å—Ç–æ—Ä—ñ—è –±—ñ–ª—å—à–µ –Ω–µ –∑–±–µ—Ä—ñ–≥–∞—î—Ç—å—Å—è –ª–æ–∫–∞–ª—å–Ω–æ. <br>–í—Å—ñ –¥–∞–Ω—ñ —Ç–µ–ø–µ—Ä —É –≤–∞—à—ñ–π Google –¢–∞–±–ª–∏—Ü—ñ!
        </div>`;
    };

    const clearHistory = () => {
        showToast('–û—á–∏—Å—Ç–∏—Ç–∏ —ñ—Å—Ç–æ—Ä—ñ—é –º–æ–∂–Ω–∞ –ª–∏—à–µ –±–µ–∑–ø–æ—Å–µ—Ä–µ–¥–Ω—å–æ –≤ Google –¢–∞–±–ª–∏—Ü—ñ.', true);
    };

    const removeShiftFromHistory = (date, shiftId) => {
        showToast('–í–∏–¥–∞–ª–∏—Ç–∏ –∑–º—ñ–Ω—É –º–æ–∂–Ω–∞ –ª–∏—à–µ –±–µ–∑–ø–æ—Å–µ—Ä–µ–¥–Ω—å–æ –≤ Google –¢–∞–±–ª–∏—Ü—ñ.', true);
    };

    /* ======= –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö —É —Ñ–∞–π–ª (–∑ localStorage) ======= */
    const saveHistoryToFile = () => {
        const historyData = {
            history: JSON.parse(localStorage.getItem('glassHistory')) || {},
            workers: JSON.parse(localStorage.getItem('workers')) || [],
            prices: Object.fromEntries(allCategories),
            taxRate: parseFloat(localStorage.getItem('glassTaxRate')) || 0
        };

        const dataStr = JSON.stringify(historyData, null, 2);
        const blob = new Blob([dataStr], { type: 'application/json' });
        const url = URL.createObjectURL(blob);

        const a = document.createElement('a');
        a.href = url;
        a.download = `–∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä_—Å–∫–ª–æ_—Ä–µ–∑–µ—Ä–≤–Ω–∞_–∫–æ–ø—ñ—è_${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        showToast('–†–µ–∑–µ—Ä–≤–Ω—É –∫–æ–ø—ñ—é –∑–±–µ—Ä–µ–∂–µ–Ω–æ!');
    };

    /* ======= –í—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö –∑ —Ñ–∞–π–ª—É ======= */
    loadFileInput.addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (!file) {
            return;
        }

        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const data = JSON.parse(e.target.result);
                if (confirm('–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ –≤—ñ–¥–Ω–æ–≤–∏—Ç–∏ –¥–∞–Ω—ñ –∑ —Ü—å–æ–≥–æ —Ñ–∞–π–ª—É? –ü–æ—Ç–æ—á–Ω—ñ –¥–∞–Ω—ñ –±—É–¥—É—Ç—å –∑–∞–º—ñ–Ω–µ–Ω—ñ.')) {
                    if (data.history) localStorage.setItem('glassHistory', JSON.stringify(data.history));
                    if (data.workers) localStorage.setItem('workers', JSON.stringify(data.workers));
                    if (data.prices) {
                        const custom = {};
                        const glass = {};
                        for (const key in data.prices) {
                            if (defaultGlassTypes[key]) {
                                glass[key] = data.prices[key];
                            } else {
                                custom[key] = data.prices[key];
                            }
                        }
                        localStorage.setItem('glassPrices', JSON.stringify(glass));
                        localStorage.setItem('customCategories', JSON.stringify(custom));
                    }
                    if (data.taxRate) localStorage.setItem('glassTaxRate', data.taxRate);
                    showToast('–î–∞–Ω—ñ —É—Å–ø—ñ—à–Ω–æ –≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–æ!');
                    window.location.reload();
                }
            } catch (error) {
                showToast('–ü–æ–º–∏–ª–∫–∞: –ù–µ–º–æ–∂–ª–∏–≤–æ –ø—Ä–æ—á–∏—Ç–∞—Ç–∏ —Ñ–∞–π–ª. –ü–µ—Ä–µ–∫–æ–Ω–∞–π—Ç–µ—Å—è, —â–æ —Ü–µ –∫–æ—Ä–µ–∫—Ç–Ω–∏–π —Ñ–∞–π–ª —Ä–µ–∑–µ—Ä–≤–Ω–æ—ó –∫–æ–ø—ñ—ó.', true);
            }
        };
        reader.readAsText(file);
    });
    
    restoreBtn.addEventListener('click', () => {
        loadFileInput.click();
    });

    /* ======= –£–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è –ø—Ä–∞—Ü—ñ–≤–Ω–∏–∫–∞–º–∏ ======= */
    let editWorkerIndex = null;

    const renderWorkers = () => {
        const workers = getWorkers();
        workerListEl.innerHTML = '';
        workerFilterSelect.innerHTML = '<option value="all">–í—Å—ñ –ø—Ä–∞—Ü—ñ–≤–Ω–∏–∫–∏</option>';
        if (workers.length === 0) {
            workerListEl.innerHTML = `<div style="color:var(--muted);padding:6px 0;">–ü–æ–∫–∏ —â–æ –Ω–µ–º–∞—î –ø—Ä–∞—Ü—ñ–≤–Ω–∏–∫—ñ–≤. –î–æ–¥–∞–π –ø–µ—Ä—à–æ–≥–æ –Ω–∏–∂—á–µ üëá</div>`;
            return;
        }
        workers.forEach((w, i) => {
            const row = document.createElement('div');
            row.className = 'workers-grid-item';
            row.dataset.index = i;
            row.innerHTML = `
                <div class="name">${w.name}</div>
                <div class="coef">–∫–æ–µ—Ñ. ${Number(w.coef).toFixed(2)}</div>
                <div class="actions">
                    <button class="edit-btn">‚úé</button>
                    <button class="del-btn">‚úñ</button>
                </div>
            `;
            workerListEl.appendChild(row);
            const option = document.createElement('option');
            option.value = w.name;
            option.textContent = w.name;
            workerFilterSelect.appendChild(option);
        });
    };

    const startEditWorker = (index) => {
        const workers = getWorkers();
        const w = workers[index];
        document.getElementById('workerName').value = w.name;
        document.getElementById('workerCoef').value = w.coef;
        editWorkerIndex = index;
        addOrUpdateWorkerBtn.textContent = '–û–Ω–æ–≤–∏—Ç–∏';
    };

    const resetWorkerForm = () => {
        document.getElementById('workerName').value = '';
        document.getElementById('workerCoef').value = '';
        editWorkerIndex = null;
        addOrUpdateWorkerBtn.textContent = '–î–æ–¥–∞—Ç–∏';
    };

    const handleAddOrUpdateWorker = () => {
        const name = document.getElementById('workerName').value.trim();
        const coef = parseFloat(document.getElementById('workerCoef').value);

        if (!name || isNaN(coef) || coef <= 0) {
            showToast('–ë—É–¥—å –ª–∞—Å–∫–∞, –≤–≤–µ–¥—ñ—Ç—å –∫–æ—Ä–µ–∫—Ç–Ω—ñ —ñ–º\'—è —Ç–∞ –∫–æ–µ—Ñ—ñ—Ü—ñ—î–Ω—Ç (–±—ñ–ª—å—à–µ 0)!', true);
            return;
        }

        let workers = getWorkers();

        if (editWorkerIndex !== null) {
            const isNameTaken = workers.some((w, i) => i !== editWorkerIndex && w.name.toLowerCase() === name.toLowerCase());
            if (isNameTaken) {
                showToast('–Ü–º‚Äô—è –≤–∂–µ –∑–∞–π–Ω—è—Ç–µ —ñ–Ω—à–∏–º –ø—Ä–∞—Ü—ñ–≤–Ω–∏–∫–æ–º.', true);
                return;
            }
            workers[editWorkerIndex] = { name, coef };
        } else {
            const isNameTaken = workers.some(w => w.name.toLowerCase() === name.toLowerCase());
            if (isNameTaken) {
                showToast('–ü—Ä–∞—Ü—ñ–≤–Ω–∏–∫ –∑ —Ç–∞–∫–∏–º —ñ–º‚Äô—è–º –≤–∂–µ —ñ—Å–Ω—É—î. –ë—É–¥—å –ª–∞—Å–∫–∞, –≤–∫–∞–∂—ñ—Ç—å —É–Ω—ñ–∫–∞–ª—å–Ω–µ —ñ–º\'—è –∞–±–æ –≤—ñ–¥—Ä–µ–¥–∞–≥—É–π—Ç–µ —ñ—Å–Ω—É—é—á–æ–≥–æ.', true);
                return;
            }
            workers.push({ name, coef });
        }

        saveWorkers(workers);
        renderWorkers();
        renderWorkerCheckboxes(getSelectedWorkers());
        renderWorkerTotals();
        resetWorkerForm();
        displayHistory();
        showToast('–î–∞–Ω—ñ –ø—Ä–∞—Ü—ñ–≤–Ω–∏–∫–∞ –æ–Ω–æ–≤–ª–µ–Ω–æ!');
    };

    const removeWorker = (index) => {
        if (confirm('–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ –≤–∏–¥–∞–ª–∏—Ç–∏ —Ü—å–æ–≥–æ –ø—Ä–∞—Ü—ñ–≤–Ω–∏–∫–∞?')) {
            const workers = getWorkers();
            const removed = workers.splice(index, 1);
            saveWorkers(workers);
            renderWorkers();
            renderWorkerCheckboxes(getSelectedWorkers().filter(w => w.name !== removed[0].name));
            renderWorkerTotals();
            displayHistory();
            showToast('–ü—Ä–∞—Ü—ñ–≤–Ω–∏–∫–∞ –≤–∏–¥–∞–ª–µ–Ω–æ!');
        }
    };

    /* ======= –ü—ñ–¥—Å—É–º–æ–∫ –ø–æ –ø—Ä–∞—Ü—ñ–≤–Ω–∏–∫–∞—Ö –∑–∞ –º—ñ—Å—è—Ü—å ======= */
    const renderWorkerTotals = () => {
        workerTotalsEl.innerHTML = `<div style="color:var(--muted);padding:6px 0;">–ü—ñ–¥—Å—É–º–æ–∫ –¥–æ—Å—Ç—É–ø–Ω–∏–π –ª–∏—à–µ –ø—Ä–∏ –ª–æ–∫–∞–ª—å–Ω–æ–º—É –∑–±–µ—Ä—ñ–≥–∞–Ω–Ω—ñ –¥–∞–Ω–∏—Ö.</div>`;
    };

    /* ======= –ì—Ä–∞—Ñ—ñ–∫ –∑–∞—Ä–æ–±—ñ—Ç–∫—É ======= */
    const renderEarningsChart = () => {
        if (chartInstance) { chartInstance.destroy(); }
        const ctx = earningsChartCanvas.getContext('2d');
        ctx.clearRect(0, 0, earningsChartCanvas.width, earningsChartCanvas.height);
        document.getElementById('earningsChart').style.display = 'none';
        historyEl.querySelector('h3').textContent = '–ì—Ä–∞—Ñ—ñ–∫ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∏–π';
    };

    /* ======= –î–æ–ø–æ–º—ñ–∂–Ω—ñ ======= */
    const getSelectedWorkers = () => {
        const workers = getWorkers();
        const selected = [];
        document.querySelectorAll('#workerCheckboxes input:checked').forEach(ch => {
            const w = workers.find(x => x.name === ch.value);
            if (w) selected.push({ name: w.name, coef: Number(w.coef) });
        });
        return selected;
    };

    const switchToTab = (key) => {
        const btn = document.querySelector(`.tab-btn[data-tab="${key}"]`);
        if (btn) btn.click();
    };

    /* ======= –°—Ç–∞—Ä—Ç ======= */
    loadTheme();
    loadPrices();
    createInputs();
    renderWorkers();
    renderWorkerTotals();
    restoreTab();

    const today = new Date().toISOString().split('T')[0];
    dateInput.value = localStorage.getItem('lastDate') || today;
    
    // --- Event Listeners ---
    themeToggleBtn.addEventListener('click', toggleTheme);
    dateInput.addEventListener('change', () => {
        localStorage.setItem('lastDate', dateInput.value);
        clearCurrentForm();
    });
    
    // Main buttons
    saveBtn.addEventListener('click', saveData);
    savePricesBtn.addEventListener('click', savePrices);
    saveFileBtn.addEventListener('click', saveHistoryToFile);
    clearBtn.addEventListener('click', clearHistory);
    clearCurrentBtn.addEventListener('click', clearCurrentForm);
    addShiftBtn.addEventListener('click', () => { clearCurrentForm(); showToast('–§–æ—Ä–º–∞ –æ—á–∏—â–µ–Ω–∞, –º–æ–∂–Ω–∞ –¥–æ–¥–∞—Ç–∏ –Ω–æ–≤—É –∑–º—ñ–Ω—É'); });
    addOrUpdateWorkerBtn.addEventListener('click', handleAddOrUpdateWorker);
    resetWorkerBtn.addEventListener('click', resetWorkerForm);
    addOrUpdateCategoryBtn.addEventListener('click', handleAddOrUpdateCategory);
    resetCategoryBtn.addEventListener('click', resetCategoryForm);
    workerFilterSelect.addEventListener('change', displayHistory);
    
    // Event delegation for dynamically created elements
    historyEl.addEventListener('click', (e) => {
        const deleteBtn = e.target.closest('.history-delete-btn');
        const editBtn = e.target.closest('.history-edit-btn');
        const toggleBtn = e.target.closest('[data-toggle-date]');
        
        if (deleteBtn) {
            const date = deleteBtn.dataset.date;
            const shiftId = deleteBtn.dataset.shiftId;
            e.stopPropagation();
            removeShiftFromHistory(date, shiftId);
        } else if (editBtn) {
            const date = editBtn.dataset.date;
            const shiftId = editBtn.dataset.shiftId;
            e.stopPropagation();
            switchToTab('calc');
            loadShiftForEdit(date, shiftId);
        } else if (toggleBtn) {
            const date = toggleBtn.dataset.toggleDate;
            const shiftsList = historyEl.querySelector(`[data-date-shifts="${date}"]`);
            if (shiftsList) {
                shiftsList.style.display = shiftsList.style.display === 'none' ? 'block' : 'none';
                toggleBtn.textContent = shiftsList.style.display === 'none' ? '‚ñº' : '‚ñ≤';
            }
        }
    });

    workerListEl.addEventListener('click', (e) => {
        const editBtn = e.target.closest('.edit-btn');
        const delBtn = e.target.closest('.del-btn');
        const listItem = e.target.closest('.workers-grid-item');
        if (!listItem) return;

        const index = parseInt(listItem.dataset.index);

        if (editBtn) {
            startEditWorker(index);
        } else if (delBtn) {
            removeWorker(index);
        }
    });

    customCategoriesListEl.addEventListener('click', (e) => {
        const delBtn = e.target.closest('.del-btn');
        const editBtn = e.target.closest('.edit-btn');
        const listItem = e.target.closest('.workers-grid-item');
        if (!listItem) return;

        const id = listItem.dataset.id;
        
        if (delBtn) {
            removeCustomCategory(id);
        } else if (editBtn) {
            startEditCategory(id);
        }
    });
});
</script>
</body>

</html>

